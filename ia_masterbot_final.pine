//@version=6
indicator("MASTER BOT ACTUALIZADO SL DINAMICOS v9", overlay=true)

// === Inputs de visualizaci√≥n ===
mostrar_ema13 = input.bool(true, "Mostrar EMA 13")
mostrar_ema34 = input.bool(true, "Mostrar EMA 34")
mostrar_ema55 = input.bool(true, "Mostrar EMA 55") // Nueva opci√≥n para EMA 55
mostrar_ema200 = input.bool(true, "Mostrar EMA 200") // Nueva opci√≥n para EMA 200
mostrar_long = input.bool(true, "Mostrar se√±ales LONG")
mostrar_short = input.bool(true, "Mostrar se√±ales SHORT")
mostrar_sl_inicial = input.bool(true, "Mostrar STOP LOSS INICIAL")
mostrar_tp1 = input.bool(true, "Mostrar TP1")
mostrar_sl_entrada = input.bool(true, "Mostrar SL en entrada")
mostrar_tp2 = input.bool(true, "Mostrar TP2")
mostrar_sl_tp1 = input.bool(true, "Mostrar SL TP1")
mostrar_tp3 = input.bool(true, "Mostrar TP3")
mostrar_sl_final = input.bool(true, "Mostrar SL final")

// === C√°lculo de EMAs ===
ema13 = ta.ema(close, 13)
ema34 = ta.ema(close, 34)
ema55 = ta.ema(close, 55)      // EMA 55
ema200 = ta.ema(close, 200)    // EMA 200
ema13_1h = request.security(syminfo.tickerid, "60", ta.ema(close, 13))
ema34_1h = request.security(syminfo.tickerid, "60", ta.ema(close, 34))

tendenciaPrincipalAlcista = ema13_1h > ema34_1h
tendenciaPrincipalBajista = ema13_1h < ema34_1h
cruceAlcista = ta.crossover(ema13, ema34)
cruceBajista = ta.crossunder(ema13, ema34)
cruceAlcistaValidado = cruceAlcista and tendenciaPrincipalAlcista
cruceBajistaValidado = cruceBajista and tendenciaPrincipalBajista

// ------ Variables normales de estrategia ------
var float sl_long = na
var float sl_short = na
var float tp1_long = na
var float tp1_short = na
var float tp2_long = na
var float tp2_short = na
var float tp3_long = na
var float tp3_short = na
var float precio_entrada_long = na
var float precio_entrada_short = na
var int barra_entrada_long = na
var int barra_entrada_short = na
var bool long_activa = false
var bool short_activa = false
var bool tp1_long_mostrado = false
var bool tp1_short_mostrado = false
var bool tp2_long_mostrado = false
var bool tp2_short_mostrado = false
var bool tp3_long_mostrado = false
var bool tp3_short_mostrado = false
var bool sl_long_a_entrada = false
var bool sl_short_a_entrada = false
var bool sl_long_en_tp1 = false
var bool sl_short_en_tp1 = false
var bool sl_long_en_tp3 = false
var bool sl_short_en_tp3 = false

var int conteo_toques_sl_tp1_long = 0
var float last_touch_sl_tp1_long = na
var int conteo_toques_sl_tp1_short = 0
var float last_touch_sl_tp1_short = na
var int conteo_toques_sl_tp3_long = 0
var float last_touch_sl_tp3_long = na
var int conteo_toques_sl_tp3_short = 0
var float last_touch_sl_tp3_short = na

var int conteo_toques_long = 0
var int conteo_toques_short = 0
var float last_touch_long = na
var float last_touch_short = na

// Variables para el SL EMA34 - SEGUNDO TOQUE o PRIMER TOQUE seg√∫n condici√≥n
var int conteo_toques_sl_ema34_long = 0
var float last_touch_sl_ema34_long = na
var int conteo_toques_sl_ema34_short = 0
var float last_touch_sl_ema34_short = na

// Variables para la condici√≥n del 0.2% respecto a EMA13 (modificado)
var bool sl_ema34_primer_toque_long = false
var bool sl_ema34_primer_toque_short = false

// ------ Variables para se√±ales anticipadas y canceladas ------
var bool long_anticipada = false
var int bar_long_anticipada = na
var label label_long_ant = na
var bool long_anticipada_cancelada = false
var float precio_long_ant = na

var bool short_anticipada = false
var int bar_short_anticipada = na
var label label_short_ant = na
var bool short_anticipada_cancelada = false
var float precio_short_ant = na

// --- NUEVAS VARIABLES PARA REENTRADA TRAS SL ---
var bool short_sl_reciente = false
var int bar_short_sl_reciente = na
var bool long_sl_reciente = false
var int bar_long_sl_reciente = na

// --- NUEVAS VARIABLES PARA SL DIN√ÅMICO EN DOBLE TOQUE ---
var float primer_toque_ema34_long = na
var bool esperando_segundo_toque_long = false
var float primer_toque_ema34_short = na
var bool esperando_segundo_toque_short = false

// === Variables para SL din√°mico en SL ENTRADA (break even) y SL TP1 ===
var float primer_toque_break_even_long = na
var bool esperando_caida_break_even_long = false
var float primer_toque_break_even_short = na
var bool esperando_subida_break_even_short = false

var float primer_toque_sl_tp1_long = na
var bool esperando_caida_sl_tp1_long = false
var float primer_toque_sl_tp1_short = na
var bool esperando_subida_sl_tp1_short = false

sl_buffer = 0.2

// =================== NUEVA L√ìGICA: CRUCE CON VOLUMEN (SL EN EMA13) ===================
// Variables y l√≥gica para entradas inmediatas si el cruce supera 0.2% respecto a EMA13_1h
var bool cruce_volumen_long_activo = false
var bool cruce_volumen_short_activo = false
var float precio_entrada_cruce_vol_long = na
var float precio_entrada_cruce_vol_short = na
var float sl_cruce_vol_long = na
var float sl_cruce_vol_short = na
var int barra_cruce_vol_long = na
var int barra_cruce_vol_short = na
var bool cruce_vol_long_tp1 = false
var bool cruce_vol_short_tp1 = false
var bool cruce_vol_long_tp2 = false
var bool cruce_vol_short_tp2 = false

// --- REENTRADA TRAS TP3 CON SEGUNDO TOQUE EN EMA13 ---
// Variables nuevas (deben ir al inicio del script, junto al resto de variables globales)
var bool esperando_reentrada_tp3_ema13_long = false
var bool esperando_reentrada_tp3_ema13_short = false
var int reentrada_tp3_ema13_toques_long = 0
var int reentrada_tp3_ema13_toques_short = 0
var float reentrada_tp3_ema13_precio_entrada_long = na
var float reentrada_tp3_ema13_precio_entrada_short = na
var float reentrada_tp3_ema13_sl_long = na
var float reentrada_tp3_ema13_sl_short = na
var float reentrada_tp3_ema13_tp1_long = na
var float reentrada_tp3_ema13_tp2_long = na
var float reentrada_tp3_ema13_tp3_long = na
var float reentrada_tp3_ema13_tp1_short = na
var float reentrada_tp3_ema13_tp2_short = na
var float reentrada_tp3_ema13_tp3_short = na
var bool reentrada_tp3_ema13_activa_long = false
var bool reentrada_tp3_ema13_activa_short = false
var bool reentrada_tp3_ema13_tp1_long_mostrado = false
var bool reentrada_tp3_ema13_tp2_long_mostrado = false
var bool reentrada_tp3_ema13_tp1_short_mostrado = false
var bool reentrada_tp3_ema13_tp2_short_mostrado = false

var float tp1_vol = na
var float tp2_vol = na
var float tp3_vol = na


// === NUEVAS BANDERAS PARA REENTRADA TRAS TP3 Y CRUCE EMA34 ===
var bool esperando_reentrada_tp3_short = false
var bool esperando_reentrada_tp3_long = false

// === Ploteo de EMAs ===
plot(mostrar_ema13 ? ema13 : na, title="EMA 13", color=color.yellow, linewidth=2)
plot(mostrar_ema34 ? ema34 : na, title="EMA 34", color=color.white, linewidth=2)
plot(mostrar_ema55 ? ema55 : na, title="EMA 55", color=color.red, linewidth=2)      // EMA 55 en rojo
plot(mostrar_ema200 ? ema200 : na, title="EMA 200", color=color.blue, linewidth=2)  // EMA 200 en azul

// ======= SOLO UNA VEZ LA FUNCI√ìN =========
safeToString(x) =>
    na(x) ? "0" : str.tostring(x)
// =========================================

// CRUCE ALCISTA CON VOLUMEN (LONG, SL DIN√ÅMICO EN EMA13)
if cruceAlcista and tendenciaPrincipalAlcista and not long_activa and not cruce_volumen_long_activo and not short_activa and not cruce_volumen_short_activo
    float distancia_long_vol = ((low - ema13_1h) / ema13_1h) * 100
    if distancia_long_vol > 0.2
        // Activa LONG y limpia SHORT
        cruce_volumen_long_activo := true
        precio_entrada_cruce_vol_long := low
        sl_cruce_vol_long := ema13
        barra_cruce_vol_long := bar_index
        cruce_vol_long_tp1 := false
        cruce_vol_long_tp2 := false
        // Limpia SHORT de volumen
        cruce_volumen_short_activo := false
        precio_entrada_cruce_vol_short := na
        sl_cruce_vol_short := na
        barra_cruce_vol_short := na
        cruce_vol_short_tp1 := false
        cruce_vol_short_tp2 := false
        // ASIGNACI√ìN DE TP DE VOLUMEN LONG
        tp1_vol := precio_entrada_cruce_vol_long * 1.01
        tp2_vol := precio_entrada_cruce_vol_long * 1.03
        tp3_vol := precio_entrada_cruce_vol_long * 1.05
        // Etiqueta especial
        label.new(bar_index, low - syminfo.mintick * 25, "LONG (SL EMA 13)\n" + str.tostring(precio_entrada_cruce_vol_long, "#.#####"), style=label.style_label_up, color=color.green, textcolor=color.white)
        alert('{"evento":"ENTRADA LONG CRUCE VOLUMEN","tipo_entrada":"cruce_volumen","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(precio_entrada_cruce_vol_long) + ',"stop_loss":' + safeToString(sl_cruce_vol_long) + ',"tp1":' + safeToString(tp1_vol) + ',"tp2":' + safeToString(tp2_vol) + ',"tp3":' + safeToString(tp3_vol) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34}', alert.freq_once_per_bar)

// CRUCE BAJISTA CON VOLUMEN (SHORT, SL DIN√ÅMICO EN EMA13)
if cruceBajista and tendenciaPrincipalBajista and not short_activa and not cruce_volumen_short_activo and not long_activa and not cruce_volumen_long_activo
    float distancia_short_vol = ((ema13_1h - high) / ema13_1h) * 100
    if distancia_short_vol > 0.2
        // Activa SHORT y limpia LONG
        cruce_volumen_short_activo := true
        precio_entrada_cruce_vol_short := high
        sl_cruce_vol_short := ema13
        barra_cruce_vol_short := bar_index
        cruce_vol_short_tp1 := false
        cruce_vol_short_tp2 := false
        // Limpia LONG de volumen
        cruce_volumen_long_activo := false
        precio_entrada_cruce_vol_long := na
        sl_cruce_vol_long := na
        barra_cruce_vol_long := na
        cruce_vol_long_tp1 := false
        cruce_vol_long_tp2 := false
        // ASIGNACI√ìN DE TP DE VOLUMEN SHORT
        tp1_vol := precio_entrada_cruce_vol_short * 0.99
        tp2_vol := precio_entrada_cruce_vol_short * 0.97
        tp3_vol := precio_entrada_cruce_vol_short * 0.95
        // Etiqueta especial
        label.new(bar_index, high + syminfo.mintick * 25, "SHORT (SL EMA 13)\n" + str.tostring(precio_entrada_cruce_vol_short, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
        alert('{"evento":"ENTRADA SHORT CRUCE VOLUMEN","tipo_entrada":"cruce_volumen","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(precio_entrada_cruce_vol_short) + ',"stop_loss":' + safeToString(sl_cruce_vol_short) + ',"tp1":' + safeToString(tp1_vol) + ',"tp2":' + safeToString(tp2_vol) + ',"tp3":' + safeToString(tp3_vol) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34}', alert.freq_once_per_bar)

// SL DIN√ÅMICO PARA CRUCE VOLUMEN LONG
if cruce_volumen_long_activo
    sl_cruce_vol_long := ema13 // <-- Actualiza el SL en cada vela
    if low <= sl_cruce_vol_long
        string sl_label = not cruce_vol_long_tp1 ? "üü© SL EMA13 ‚Üì\n" : (not cruce_vol_long_tp2 ? "üü© SL BREAK EVEN ‚Üì\n" : "üü© SL TP1 ‚Üì\n")
        sl_label := sl_label + safeToString(sl_cruce_vol_long)
        label.new(bar_index, low - syminfo.mintick * 40, sl_label + "\n(LONG SL EMA13)", style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL LONG EMA13 CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"stop_loss":' + safeToString(sl_cruce_vol_long) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_volumen_long_activo := false
        cruce_vol_long_tp1 := false
        cruce_vol_long_tp2 := false
        long_sl_reciente := true
        bar_long_sl_reciente := bar_index
    // TP1
    if not cruce_vol_long_tp1 and high >= tp1_vol
        label.new(bar_index, tp1_vol + syminfo.mintick * 10, "TP1 (SL EMA13)\n" + str.tostring(tp1_vol, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP1 LONG CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp1_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_vol_long_tp1 := true
        sl_cruce_vol_long := precio_entrada_cruce_vol_long
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_cruce_vol_long) + '}', alert.freq_once_per_bar)
    // TP2
    if cruce_vol_long_tp1 and not cruce_vol_long_tp2 and high >= tp2_vol
        label.new(bar_index, tp2_vol + syminfo.mintick * 10, "TP2 (SL EMA13)\n" + str.tostring(tp2_vol, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP2 LONG CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp2_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_vol_long_tp2 := true
        sl_cruce_vol_long := tp1_vol
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_cruce_vol_long) + '}', alert.freq_once_per_bar)
    // TP3 (cierre)
    if cruce_vol_long_tp2 and high >= tp3_vol
        label.new(bar_index, tp3_vol + syminfo.mintick * 10, "TP3 (SL EMA13) - CIERRE\n" + str.tostring(tp3_vol, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP3 LONG CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp3_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_volumen_long_activo := false
        cruce_vol_long_tp1 := false
        cruce_vol_long_tp2 := false

// SL DIN√ÅMICO PARA CRUCE VOLUMEN SHORT
if cruce_volumen_short_activo
    sl_cruce_vol_short := ema13 // <-- Actualiza el SL en cada vela
    if high >= sl_cruce_vol_short
        string sl_label = not cruce_vol_short_tp1 ? "üü• SL EMA13 ‚Üë\n" : (not cruce_vol_short_tp2 ? "üü• SL BREAK EVEN ‚Üë\n" : "üü• SL TP1 ‚Üë\n")
        sl_label := sl_label + safeToString(sl_cruce_vol_short)
        label.new(bar_index, high + syminfo.mintick * 40, sl_label + "\n(SHORT SL EMA13)", style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL SHORT EMA13 CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"stop_loss":' + safeToString(sl_cruce_vol_short) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_volumen_short_activo := false
        cruce_vol_short_tp1 := false
        cruce_vol_short_tp2 := false
        short_sl_reciente := true
        bar_short_sl_reciente := bar_index
    // TP1
    if not cruce_vol_short_tp1 and low <= tp1_vol
        label.new(bar_index, tp1_vol - syminfo.mintick * 10, "TP1 (SL EMA13)\n" + str.tostring(tp1_vol, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP1 SHORT CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp1_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_vol_short_tp1 := true
        sl_cruce_vol_short := precio_entrada_cruce_vol_short
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_cruce_vol_short) + '}', alert.freq_once_per_bar)
    // TP2
    if cruce_vol_short_tp1 and not cruce_vol_short_tp2 and low <= tp2_vol
        label.new(bar_index, tp2_vol - syminfo.mintick * 10, "TP2 (SL EMA13)\n" + str.tostring(tp2_vol, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP2 SHORT CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp2_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_vol_short_tp2 := true
        sl_cruce_vol_short := tp1_vol
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_cruce_vol_short) + '}', alert.freq_once_per_bar)
    // TP3 (cierre)
    if cruce_vol_short_tp2 and low <= tp3_vol
        label.new(bar_index, tp3_vol - syminfo.mintick * 10, "TP3 (SL EMA13) - CIERRE\n" + str.tostring(tp3_vol, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP3 SHORT CRUCE VOLUMEN","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp3_vol) + ',"tipo_entrada":"cruce_volumen"}', alert.freq_once_per_bar)
        cruce_volumen_short_activo := false
        cruce_vol_short_tp1 := false
        cruce_vol_short_tp2 := false

// SE√ëALES ANTICIPADAS Y APERTURA SOLO SI <=0.2% SOBRE EMA13_1H
if not short_anticipada and not short_anticipada_cancelada and cruceBajista and tendenciaPrincipalBajista and not cruce_volumen_short_activo
    float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
    short_anticipada := true
    bar_short_anticipada := bar_index
    precio_short_ant := high
    if mostrar_short
        label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT", style=label.style_label_down, color=color.new(color.aqua, 0), textcolor=color.white)
    short_anticipada_cancelada := false
    long_anticipada := false
    long_anticipada_cancelada := false
    if distancia_short <= 0.2
        alert('{"evento":"PREENTRADA SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

// LONG
if not long_anticipada and not long_anticipada_cancelada and cruceAlcista and tendenciaPrincipalAlcista and not cruce_volumen_long_activo
    float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
    long_anticipada := true
    bar_long_anticipada := bar_index
    precio_long_ant := low
    if mostrar_long
        label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT", style=label.style_label_up, color=color.new(color.aqua, 0), textcolor=color.white)
    long_anticipada_cancelada := false
    short_anticipada := false
    short_anticipada_cancelada := false
    if distancia_long <= 0.2
        alert('{"evento":"PREENTRADA LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

// ACTUALIZACI√ìN SL DIN√ÅMICO EN EMA34_1H MIENTRAS NO SE CONFIRMA SE√ëAL REAL
if short_anticipada and not short_activa
    alert('{"evento":"ACTUALIZA SL DINAMICO SHORT","EMA34_1H":' + safeToString(ema34_1h) + '}', alert.freq_once_per_bar)

if long_anticipada and not long_activa
    alert('{"evento":"ACTUALIZA SL DINAMICO LONG","EMA34_1H":' + safeToString(ema34_1h) + '}', alert.freq_once_per_bar)

// CANCELACI√ìN DE SE√ëALES ANTICIPADAS Y CIERRE INMEDIATO PARA BYBIT
if long_anticipada and close < ema13
    if not long_anticipada_cancelada
        label.new(bar_index, low - syminfo.mintick * 20, "‚ùå", style=label.style_label_up, color=color.red, textcolor=color.white)
        if not na(label_long_ant)
            label.set_color(label_long_ant, color.gray)
            label.set_textcolor(label_long_ant, color.white)
        long_anticipada_cancelada := true
        alert('{"evento":"CERRAR LONG POR CANCELACION ANTICIPADA","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":0,"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    long_anticipada := false

if short_anticipada and close > ema13
    if not short_anticipada_cancelada
        label.new(bar_index, high + syminfo.mintick * 20, "‚ùå", style=label.style_label_down, color=color.red, textcolor=color.white)
        if not na(label_short_ant)
            label.set_color(label_short_ant, color.gray)
            label.set_textcolor(label_short_ant, color.white)
        short_anticipada_cancelada := true
        alert('{"evento":"CERRAR SHORT POR CANCELACION ANTICIPADA","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":0,"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    short_anticipada := false

// REENTRADAS (PULLBACK Y TRAS SL) SOLO EN FAVOR DE TENDENCIA PRINCIPAL Y CON EL FILTRO DE DISTANCIA
if short_anticipada_cancelada and not cruceAlcista and tendenciaPrincipalBajista and not esperando_reentrada_tp3_short and not cruce_volumen_short_activo
    if close < ema13 and not short_anticipada
        float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
        short_anticipada := true
        bar_short_anticipada := bar_index
        precio_short_ant := high
        if mostrar_short
            label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT (PULLBACK)", style=label.style_label_down, color=color.new(color.aqua, 0), textcolor=color.white)
        short_anticipada_cancelada := false
        if distancia_short <= 0.2
            alert('{"evento":"PREENTRADA SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

if long_anticipada_cancelada and not cruceBajista and tendenciaPrincipalAlcista and not esperando_reentrada_tp3_long and not cruce_volumen_long_activo
    if close > ema13 and not long_anticipada
        float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
        long_anticipada := true
        bar_long_anticipada := bar_index
        precio_long_ant := low
        if mostrar_long
            label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT (PULLBACK)", style=label.style_label_up, color=color.new(color.aqua, 0), textcolor=color.white)
        long_anticipada_cancelada := false
        if distancia_long <= 0.2
            alert('{"evento":"PREENTRADA LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

if short_sl_reciente and not cruceAlcista and tendenciaPrincipalBajista and not short_anticipada and not short_activa and not esperando_reentrada_tp3_short and not cruce_volumen_short_activo
    if close < ema13
        float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
        short_anticipada := true
        bar_short_anticipada := bar_index
        precio_short_ant := high
        if mostrar_short
            label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT (RE-ENTRY SL)", style=label.style_label_down, color=color.new(color.yellow, 0), textcolor=color.black)
        short_sl_reciente := false
        if distancia_short <= 0.2
            alert('{"evento":"PREENTRADA SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

if long_sl_reciente and not cruceBajista and tendenciaPrincipalAlcista and not long_anticipada and not long_activa and not esperando_reentrada_tp3_long and not cruce_volumen_long_activo
    if close > ema13
        float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
        long_anticipada := true
        bar_long_anticipada := bar_index
        precio_long_ant := low
        if mostrar_long
            label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT (RE-ENTRY SL)", style=label.style_label_up, color=color.new(color.yellow, 0), textcolor=color.black)
        long_sl_reciente := false
        if distancia_long <= 0.2
            alert('{"evento":"PREENTRADA LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34_1h) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13_1h) + '}', alert.freq_once_per_bar)

if esperando_reentrada_tp3_short and not short_anticipada and not short_activa
    if close > ema34 and ema13 <= ema34 and tendenciaPrincipalBajista and not cruceAlcista
        esperando_reentrada_tp3_short := false
        short_anticipada_cancelada := true

if esperando_reentrada_tp3_long and not long_anticipada and not long_activa
    if close < ema34 and ema13 >= ema34 and tendenciaPrincipalAlcista and not cruceBajista
        esperando_reentrada_tp3_long := false
        long_anticipada_cancelada := true

// ----- CONFIRMACI√ìN DE SE√ëALES ANTICIPADAS (entrada real, se√±al roja/verde) -----
if long_anticipada and not long_anticipada_cancelada and bar_index > bar_long_anticipada and not long_activa and not cruce_volumen_long_activo
    precio_entrada_long := close[1] > open[1] ? open[1] : close[1]
    float distancia_long = ((precio_entrada_long - ema13[1]) / ema13[1]) * 100
    if distancia_long <= 0.2
        sl_long := ema34[1]
        tp1_long := precio_entrada_long * 1.01
        tp2_long := precio_entrada_long * 1.03
        tp3_long := precio_entrada_long * 1.05
        barra_entrada_long := bar_index - 1
        long_activa := true
        short_activa := false
        tp1_long_mostrado := false
        tp2_long_mostrado := false
        tp3_long_mostrado := false
        sl_long_a_entrada := false
        sl_long_en_tp1 := false
        sl_long_en_tp3 := false
        conteo_toques_long := 0
        last_touch_long := na
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        conteo_toques_sl_tp3_long := 0
        last_touch_sl_tp3_long := na
        conteo_toques_sl_ema34_long := 0
        last_touch_sl_ema34_long := na
        float distancia_long_ema34 = ((precio_entrada_long - ema13[1]) / ema13[1]) * 100
        sl_ema34_primer_toque_long := distancia_long_ema34 >= 0.2
        if mostrar_long
            label.new(bar_index - 1, low[1] - syminfo.mintick * 20, "LONG\n" + str.tostring(precio_entrada_long, "#.#####"), style=label.style_label_up, color=color.green, textcolor=color.white)
        if not na(label_long_ant)
            label.set_color(label_long_ant, color.gray)
            label.set_textcolor(label_long_ant, color.white)
        long_anticipada := false
        long_anticipada_cancelada := false
        alert('{"evento":"CONFIRMACION LONG REAL","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(precio_entrada_long) + ',"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)

if short_anticipada and not short_anticipada_cancelada and bar_index > bar_short_anticipada and not short_activa and not cruce_volumen_short_activo
    precio_entrada_short := close[1] < open[1] ? open[1] : close[1]
    float distancia_short = ((ema13[1] - precio_entrada_short) / ema13[1]) * 100
    if distancia_short <= 0.2
        sl_short := ema34[1]
        tp1_short := precio_entrada_short * 0.99
        tp2_short := precio_entrada_short * 0.97
        tp3_short := precio_entrada_short * 0.95
        barra_entrada_short := bar_index - 1
        short_activa := true
        long_activa := false
        tp1_short_mostrado := false
        tp2_short_mostrado := false
        tp3_short_mostrado := false
        sl_short_a_entrada := false
        sl_short_en_tp1 := false
        sl_short_en_tp3 := false
        conteo_toques_short := 0
        last_touch_short := na
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        conteo_toques_sl_tp3_short := 0
        last_touch_sl_tp3_short := na
        conteo_toques_sl_ema34_short := 0
        last_touch_sl_ema34_short := na
        float distancia_short_ema34 = ((ema13[1] - precio_entrada_short) / ema13[1]) * 100
        sl_ema34_primer_toque_short := distancia_short_ema34 >= 0.2
        if mostrar_short
            label.new(bar_index - 1, high[1] + syminfo.mintick * 20, "SHORT\n" + str.tostring(precio_entrada_short, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
        if not na(label_short_ant)
            label.set_color(label_short_ant, color.gray)
            label.set_textcolor(label_short_ant, color.white)
        short_anticipada := false
        short_anticipada_cancelada := false
        alert('{"evento":"CONFIRMACION SHORT REAL","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(precio_entrada_short) + ',"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)

// ----- SL inicial (SL EMA34 - doble toque/primer toque seg√∫n condici√≥n) -----
// ===========================
// SL INICIAL LONG
// ===========================
if long_activa and not sl_long_a_entrada and not sl_long_en_tp1 and not sl_long_en_tp3 and bar_index > barra_entrada_long
    if sl_ema34_primer_toque_long
        if low < ema34
            if mostrar_sl_inicial and mostrar_long
                label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.yellow, textcolor=color.black)
            alert('{"evento":"SL INICIAL LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            long_activa := false
            conteo_toques_sl_ema34_long := 0
            last_touch_sl_ema34_long := na
            esperando_segundo_toque_long := false
            primer_toque_ema34_long := na
            long_sl_reciente := true
            bar_long_sl_reciente := bar_index
    else
        if low < ema34
            if not esperando_segundo_toque_long
                primer_toque_ema34_long := low
                esperando_segundo_toque_long := true
                conteo_toques_sl_ema34_long := 1
                last_touch_sl_ema34_long := low
            else
                if not na(last_touch_sl_ema34_long) and low < last_touch_sl_ema34_long
                    conteo_toques_sl_ema34_long += 1
                last_touch_sl_ema34_long := low
                if conteo_toques_sl_ema34_long >= 2
                    if mostrar_sl_inicial and mostrar_long
                        label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.yellow, textcolor=color.black)
                    alert('{"evento":"SL INICIAL LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
                    long_activa := false
                    conteo_toques_sl_ema34_long := 0
                    last_touch_sl_ema34_long := na
                    esperando_segundo_toque_long := false
                    primer_toque_ema34_long := na
                    long_sl_reciente := true
                    bar_long_sl_reciente := bar_index
        else
            if esperando_segundo_toque_long and not na(primer_toque_ema34_long)
                float caida_natural = ((primer_toque_ema34_long - low) / primer_toque_ema34_long) * 100
                if caida_natural >= 0.2
                    if mostrar_sl_inicial and mostrar_long
                        label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 (CA√çDA) ‚Üì\n" + str.tostring(low, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
                    alert('{"evento":"SL INICIAL LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
                    long_activa := false
                    conteo_toques_sl_ema34_long := 0
                    last_touch_sl_ema34_long := na
                    esperando_segundo_toque_long := false
                    primer_toque_ema34_long := na
                    long_sl_reciente := true
                    bar_long_sl_reciente := bar_index

// ===========================
// SL INICIAL SHORT
// ===========================
if short_activa and not sl_short_a_entrada and not sl_short_en_tp1 and not sl_short_en_tp3 and bar_index > barra_entrada_short
    if sl_ema34_primer_toque_short
        if high > ema34
            if mostrar_sl_inicial and mostrar_short
                label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.yellow, textcolor=color.black)
            alert('{"evento":"SL INICIAL SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            short_activa := false
            conteo_toques_sl_ema34_short := 0
            last_touch_sl_ema34_short := na
            esperando_segundo_toque_short := false
            primer_toque_ema34_short := na
            short_sl_reciente := true
            bar_short_sl_reciente := bar_index
    else
        if high > ema34
            if not esperando_segundo_toque_short
                primer_toque_ema34_short := high
                esperando_segundo_toque_short := true
                conteo_toques_sl_ema34_short := 1   
                last_touch_sl_ema34_short := high
            else
                if not na(last_touch_sl_ema34_short) and high > last_touch_sl_ema34_short
                    conteo_toques_sl_ema34_short += 1
                last_touch_sl_ema34_short := high
                if conteo_toques_sl_ema34_short >= 2
                    if mostrar_sl_inicial and mostrar_short
                        label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.yellow, textcolor=color.black)
                    alert('{"evento":"SL INICIAL SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
                    short_activa := false
                    conteo_toques_sl_ema34_short := 0
                    last_touch_sl_ema34_short := na
                    esperando_segundo_toque_short := false
                    primer_toque_ema34_short := na
                    short_sl_reciente := true
                    bar_short_sl_reciente := bar_index
        else
            if esperando_segundo_toque_short and not na(primer_toque_ema34_short)
                float subida_natural = ((high - primer_toque_ema34_short) / primer_toque_ema34_short) * 100
                if subida_natural >= 0.2
                    if mostrar_sl_inicial and mostrar_short
                        label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 (SUBIDA) ‚Üë\n" + str.tostring(high, "#.#####"), style=label.style_label_down, color=color.yellow, textcolor=color.black)
                    alert('{"evento":"SL INICIAL SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":0,"tp2":0,"tp3":0,"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
                    short_activa := false
                    conteo_toques_sl_ema34_short := 0
                    last_touch_sl_ema34_short := na
                    esperando_segundo_toque_short := false
                    primer_toque_ema34_short := na
                    short_sl_reciente := true
                    bar_short_sl_reciente := bar_index

// TP1
if long_activa and not tp1_long_mostrado and high >= tp1_long
    if mostrar_long and mostrar_tp1
        label.new(bar_index, tp1_long + syminfo.mintick * 10, "TP1\n" + safeToString(tp1_long), style=label.style_label_down, color=color.green, textcolor=color.white)
    alert('{"evento":"TP1 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp1_long) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp1_long_mostrado := true
    sl_long := precio_entrada_long
    sl_long_a_entrada := true
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_long) + '}', alert.freq_once_per_bar)

if short_activa and not tp1_short_mostrado and low <= tp1_short
    if mostrar_short and mostrar_tp1
        label.new(bar_index, tp1_short - syminfo.mintick * 10, "TP1\n" + safeToString(tp1_short), style=label.style_label_up, color=color.red, textcolor=color.white)
    alert('{"evento":"TP1 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp1_short) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp1_short_mostrado := true
    sl_short := precio_entrada_short
    sl_short_a_entrada := true
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_short) + '}', alert.freq_once_per_bar)

// ---- SL EN ENTRADA post TP1 MODIFICADO (con SL din√°mico 0.2%) ----
if long_activa and sl_long_a_entrada
    if low <= sl_long and not esperando_caida_break_even_long
        primer_toque_break_even_long := low
        esperando_caida_break_even_long := true
    if low <= sl_long and esperando_caida_break_even_long and low < primer_toque_break_even_long
        if mostrar_long and mostrar_sl_entrada
            string sl_label = "üü© SL ENTRADA ‚Üì\n" + safeToString(sl_long)
            if sl_long == tp1_long
                sl_label := "üü© SL TP1 ‚Üì\n" + safeToString(sl_long)
            else if sl_long == tp2_long
                sl_label := "üü© SL TP2 ‚Üì\n" + safeToString(sl_long)
            else if sl_long == tp3_long
                sl_label := "üü© SL TP3 ‚Üì\n" + safeToString(sl_long)
            label.new(bar_index, low - syminfo.mintick * 40, sl_label, style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL ENTRADA LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        long_activa := false
        conteo_toques_long := 0
        last_touch_long := na
        primer_toque_break_even_long := na
        esperando_caida_break_even_long := false
    if esperando_caida_break_even_long and not na(primer_toque_break_even_long)
        float caida_break_even = ((primer_toque_break_even_long - low) / primer_toque_break_even_long) * 100
        if caida_break_even >= sl_buffer
            if mostrar_long and mostrar_sl_entrada
                label.new(bar_index, low - syminfo.mintick * 40, "üüß SL -0.2% BAJO ENTRADA ‚Üì\n" + safeToString(low), style=label.style_label_up, color=color.red, textcolor=color.white)
            alert('{"evento":"SL -0.2% LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            long_activa := false
            conteo_toques_long := 0
            last_touch_long := na
            primer_toque_break_even_long := na
            esperando_caida_break_even_long := false
    if close < ema34
        if mostrar_long and mostrar_sl_entrada
            label.new(bar_index, low - syminfo.mintick * 40, "üüß SL POST TP1 ‚Üì\n" + safeToString(ema34), style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL POST TP1 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        long_activa := false
        conteo_toques_long := 0
        last_touch_long := na
        primer_toque_break_even_long := na
        esperando_caida_break_even_long := false

if short_activa and sl_short_a_entrada
    if high >= sl_short and not esperando_subida_break_even_short
        primer_toque_break_even_short := high
        esperando_subida_break_even_short := true
    if high >= sl_short and esperando_subida_break_even_short and high > primer_toque_break_even_short
        if mostrar_short and mostrar_sl_entrada
            string sl_label = "üü• SL ENTRADA ‚Üë\n" + safeToString(sl_short)
            if sl_short == tp1_short
                sl_label := "üü• SL TP1 ‚Üë\n" + safeToString(sl_short)
            else if sl_short == tp2_short
                sl_label := "üü• SL TP2 ‚Üë\n" + safeToString(sl_short)
            else if sl_short == tp3_short
                sl_label := "üü• SL TP3 ‚Üë\n" + safeToString(sl_short)
            label.new(bar_index, high + syminfo.mintick * 40, sl_label, style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL ENTRADA SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        short_activa := false
        conteo_toques_short := 0
        last_touch_short := na
        primer_toque_break_even_short := na
        esperando_subida_break_even_short := false
    if esperando_subida_break_even_short and not na(primer_toque_break_even_short)
        float subida_break_even = ((high - primer_toque_break_even_short) / primer_toque_break_even_short) * 100
        if subida_break_even >= sl_buffer
            if mostrar_short and mostrar_sl_entrada
                label.new(bar_index, high + syminfo.mintick * 40, "üüß SL +0.2% SOBRE ENTRADA ‚Üë\n" + safeToString(high), style=label.style_label_down, color=color.red, textcolor=color.white)
            alert('{"evento":"SL +0.2% SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            short_activa := false
            conteo_toques_short := 0
            last_touch_short := na
            primer_toque_break_even_short := na
            esperando_subida_break_even_short := false
    if close > ema34
        if mostrar_short and mostrar_sl_entrada
            label.new(bar_index, high + syminfo.mintick * 40, "üüß SL POST TP1 ‚Üë\n" + safeToString(ema34), style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL POST TP1 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        short_activa := false
        conteo_toques_short := 0
        last_touch_short := na
        primer_toque_break_even_short := na
        esperando_subida_break_even_short := false

// TP2
if long_activa and not tp2_long_mostrado and high >= tp2_long
    if mostrar_long and mostrar_tp2
        label.new(bar_index, tp2_long + syminfo.mintick * 10, "TP2\n" + safeToString(tp2_long), style=label.style_label_down, color=color.green, textcolor=color.white)
    alert('{"evento":"TP2 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp2_long) + ',"porcentaje":1,"stop_loss":' + safeToString(tp1_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp2_long_mostrado := true
    sl_long := tp1_long
    sl_long_en_tp1 := true
    conteo_toques_sl_tp1_long := 0
    last_touch_sl_tp1_long := na
    // Reset SL din√°mico TP1
    primer_toque_sl_tp1_long := na
    esperando_caida_sl_tp1_long := false
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_long) + '}', alert.freq_once_per_bar)

if short_activa and not tp2_short_mostrado and low <= tp2_short
    if mostrar_short and mostrar_tp2
        label.new(bar_index, tp2_short - syminfo.mintick * 10, "TP2\n" + safeToString(tp2_short), style=label.style_label_up, color=color.red, textcolor=color.white)
    alert('{"evento":"TP2 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp2_short) + ',"porcentaje":1,"stop_loss":' + safeToString(tp1_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp2_short_mostrado := true
    sl_short := tp1_short
    sl_short_en_tp1 := true
    conteo_toques_sl_tp1_short := 0
    last_touch_sl_tp1_short := na
    // Reset SL din√°mico TP1
    primer_toque_sl_tp1_short := na
    esperando_subida_sl_tp1_short := false
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_short) + '}', alert.freq_once_per_bar)

// SL TP1 con l√≥gica de doble toque y SL din√°mico 0.2%
if long_activa and sl_long_en_tp1
    if low <= sl_long and not esperando_caida_sl_tp1_long
        primer_toque_sl_tp1_long := low
        esperando_caida_sl_tp1_long := true
    if low <= sl_long and esperando_caida_sl_tp1_long and low < primer_toque_sl_tp1_long
        if mostrar_long and mostrar_sl_tp1
            label.new(bar_index, low - syminfo.mintick * 40, "üü© SL TP1 ‚Üì\n" + safeToString(sl_long), style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL TP1 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        long_activa := false
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        primer_toque_sl_tp1_long := na
        esperando_caida_sl_tp1_long := false
    if esperando_caida_sl_tp1_long and not na(primer_toque_sl_tp1_long)
        float caida_tp1 = ((primer_toque_sl_tp1_long - low) / primer_toque_sl_tp1_long) * 100
        if caida_tp1 >= sl_buffer
            if mostrar_long and mostrar_sl_tp1
                label.new(bar_index, low - syminfo.mintick * 40, "üüß SL TP1 -0.2% ‚Üì\n" + safeToString(low), style=label.style_label_up, color=color.red, textcolor=color.white)
            alert('{"evento":"SL TP1 -0.2% LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            long_activa := false
            conteo_toques_sl_tp1_long := 0
            last_touch_sl_tp1_long := na
            primer_toque_sl_tp1_long := na
            esperando_caida_sl_tp1_long := false
    if close < ema34
        if mostrar_long and mostrar_sl_tp1
            label.new(bar_index, low - syminfo.mintick * 40, "üüß SL TP1 EMA34 ‚Üì\n" + safeToString(ema34), style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL TP1 EMA34 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        long_activa := false
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        primer_toque_sl_tp1_long := na
        esperando_caida_sl_tp1_long := false

if short_activa and sl_short_en_tp1
    if high >= sl_short and not esperando_subida_sl_tp1_short
        primer_toque_sl_tp1_short := high
        esperando_subida_sl_tp1_short := true
    if high >= sl_short and esperando_subida_sl_tp1_short and high > primer_toque_sl_tp1_short
        if mostrar_short and mostrar_sl_tp1
            label.new(bar_index, high + syminfo.mintick * 40, "üü• SL TP1 ‚Üë\n" + safeToString(sl_short), style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL TP1 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        short_activa := false
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        primer_toque_sl_tp1_short := na
        esperando_subida_sl_tp1_short := false
    if esperando_subida_sl_tp1_short and not na(primer_toque_sl_tp1_short)
        float subida_tp1 = ((high - primer_toque_sl_tp1_short) / primer_toque_sl_tp1_short) * 100
        if subida_tp1 >= sl_buffer
            if mostrar_short and mostrar_sl_tp1
                label.new(bar_index, high + syminfo.mintick * 40, "üüß SL TP1 +0.2% ‚Üë\n" + safeToString(high), style=label.style_label_down, color=color.red, textcolor=color.white)
            alert('{"evento":"SL TP1 +0.2% SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
            short_activa := false
            conteo_toques_sl_tp1_short := 0
            last_touch_sl_tp1_short := na
            primer_toque_sl_tp1_short := na
            esperando_subida_sl_tp1_short := false
    if close > ema34
        if mostrar_short and mostrar_sl_tp1
            label.new(bar_index, high + syminfo.mintick * 40, "üüß SL TP1 EMA34 ‚Üë\n" + safeToString(ema34), style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL TP1 EMA34 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(ema34) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        short_activa := false
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        primer_toque_sl_tp1_short := na
        esperando_subida_sl_tp1_short := false

// TP3 (CIERRA LA OPERACI√ìN - NO PERMITE SL FINAL)
if long_activa and not tp3_long_mostrado and high >= tp3_long
    if mostrar_long and mostrar_tp3
        label.new(bar_index, tp3_long + syminfo.mintick * 10, "TP3 TODOS LOS TARGETS CUMPLIDOS\n" + safeToString(tp3_long), style=label.style_label_down, color=color.green, textcolor=color.white)
    alert('{"evento":"TP3 LONG - CIERRE TOTAL","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp3_long) + ',"porcentaje":1,"stop_loss":' + safeToString(tp3_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp3_long_mostrado := true
    sl_long := tp3_long
    sl_long_en_tp3 := true
    conteo_toques_sl_tp3_long := 0
    last_touch_sl_tp3_long := na
    long_activa := false // CIERRE AUTOM√ÅTICO AL TP3
    esperando_reentrada_tp3_long := true // ACTIVAR BANDERA DE ESPERA
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_long) + '}', alert.freq_once_per_bar)

if short_activa and not tp3_short_mostrado and low <= tp3_short
    if mostrar_short and mostrar_tp3
        label.new(bar_index, tp3_short - syminfo.mintick * 10, "TP3 TODOS LOS TARGETS CUMPLIDOS\n" + safeToString(tp3_short), style=label.style_label_up, color=color.red, textcolor=color.white)
    alert('{"evento":"TP3 SHORT - CIERRE TOTAL","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(tp3_short) + ',"porcentaje":1,"stop_loss":' + safeToString(tp3_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
    tp3_short_mostrado := true
    sl_short := tp3_short
    sl_short_en_tp3 := true
    conteo_toques_sl_tp3_short := 0
    last_touch_sl_tp3_short := na
    short_activa := false // CIERRE AUTOM√ÅTICO AL TP3
    esperando_reentrada_tp3_short := true // ACTIVAR BANDERA DE ESPERA
    alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(sl_short) + '}', alert.freq_once_per_bar)

// SL final (SL TP3) con l√≥gica de doble toque (fondo naranja, emoji cuadrado verde/rojo)
if long_activa and sl_long_en_tp3
    if low <= sl_long
        if not na(last_touch_sl_tp3_long) and low < last_touch_sl_tp3_long
            conteo_toques_sl_tp3_long := conteo_toques_sl_tp3_long + 1
        last_touch_sl_tp3_long := low
    if conteo_toques_sl_tp3_long >= 2
        if mostrar_long and mostrar_sl_final
            label.new(bar_index, low - syminfo.mintick * 40, "üü© SL FINAL ‚Üì\n" + safeToString(sl_long), style=label.style_label_up, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL FINAL LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_long) + ',"tp1":' + safeToString(tp1_long) + ',"tp2":' + safeToString(tp2_long) + ',"tp3":' + safeToString(tp3_long) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        long_activa := false
        conteo_toques_sl_tp3_long := 0
        last_touch_sl_tp3_long := na

if short_activa and sl_short_en_tp3
    if high >= sl_short
        if not na(last_touch_sl_tp3_short) and high > last_touch_sl_tp3_short
            conteo_toques_sl_tp3_short := conteo_toques_sl_tp3_short + 1
        last_touch_sl_tp3_short := high
    if conteo_toques_sl_tp3_short >= 2
        if mostrar_short and mostrar_sl_final
            label.new(bar_index, high + syminfo.mintick * 40, "üü• SL FINAL ‚Üë\n" + safeToString(sl_short), style=label.style_label_down, color=color.orange, textcolor=color.white)
        alert('{"evento":"SL FINAL SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"porcentaje":1,"stop_loss":' + safeToString(sl_short) + ',"tp1":' + safeToString(tp1_short) + ',"tp2":' + safeToString(tp2_short) + ',"tp3":' + safeToString(tp3_short) + ',"ema13":' + safeToString(ema13) + '}', alert.freq_once_per_bar)
        short_activa := false
        conteo_toques_sl_tp3_short := 0
        last_touch_sl_tp3_short := na

// Activaci√≥n de la bandera tras TP3 (LONG)
if tp3_long_mostrado
    esperando_reentrada_tp3_ema13_long := true
    reentrada_tp3_ema13_toques_long := 0
    tp3_long_mostrado := false // para evitar m√∫ltiples activaciones

// Activaci√≥n de la bandera tras TP3 (SHORT)
if tp3_short_mostrado
    esperando_reentrada_tp3_ema13_short := true
    reentrada_tp3_ema13_toques_short := 0
    tp3_short_mostrado := false

// Conteo de toques en EMA13 tras TP3 (LONG)
if esperando_reentrada_tp3_ema13_long and not reentrada_tp3_ema13_activa_long
    if low <= ema13
        reentrada_tp3_ema13_toques_long += 1
        label.new(bar_index, ema13, "Toque EMA13 (LONG) #" + str.tostring(reentrada_tp3_ema13_toques_long), style=label.style_label_up, color=color.new(color.blue, 70), textcolor=color.white)
        if reentrada_tp3_ema13_toques_long == 2
            reentrada_tp3_ema13_precio_entrada_long := low
            reentrada_tp3_ema13_sl_long := ema34
            reentrada_tp3_ema13_tp1_long := reentrada_tp3_ema13_precio_entrada_long * 1.01
            reentrada_tp3_ema13_tp2_long := reentrada_tp3_ema13_precio_entrada_long * 1.03
            reentrada_tp3_ema13_tp3_long := reentrada_tp3_ema13_precio_entrada_long * 1.05
            reentrada_tp3_ema13_activa_long := true
            reentrada_tp3_ema13_tp1_long_mostrado := false
            reentrada_tp3_ema13_tp2_long_mostrado := false
            esperando_reentrada_tp3_ema13_long := false
            label.new(bar_index, low - syminfo.mintick * 25, "REENTRADA TP3 EMA13 LONG\n" + str.tostring(reentrada_tp3_ema13_precio_entrada_long, "#.#####"), style=label.style_label_up, color=color.new(color.lime, 0), textcolor=color.black)
            alert('{"evento":"REENTRADA TP3 EMA13 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_precio_entrada_long) + ',"stop_loss":' + safeToString(reentrada_tp3_ema13_sl_long) + ',"tp1":' + safeToString(reentrada_tp3_ema13_tp1_long) + ',"tp2":' + safeToString(reentrada_tp3_ema13_tp2_long) + ',"tp3":' + safeToString(reentrada_tp3_ema13_tp3_long) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34}', alert.freq_once_per_bar)
            alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_long) + '}', alert.freq_once_per_bar)

// Conteo de toques en EMA13 tras TP3 (SHORT)
if esperando_reentrada_tp3_ema13_short and not reentrada_tp3_ema13_activa_short
    if high >= ema13
        reentrada_tp3_ema13_toques_short += 1
        label.new(bar_index, ema13, "Toque EMA13 (SHORT) #" + str.tostring(reentrada_tp3_ema13_toques_short), style=label.style_label_down, color=color.new(color.blue, 70), textcolor=color.white)
        if reentrada_tp3_ema13_toques_short == 2
            reentrada_tp3_ema13_precio_entrada_short := high
            reentrada_tp3_ema13_sl_short := ema34
            reentrada_tp3_ema13_tp1_short := reentrada_tp3_ema13_precio_entrada_short * 0.99
            reentrada_tp3_ema13_tp2_short := reentrada_tp3_ema13_precio_entrada_short * 0.97
            reentrada_tp3_ema13_tp3_short := reentrada_tp3_ema13_precio_entrada_short * 0.95
            reentrada_tp3_ema13_activa_short := true
            reentrada_tp3_ema13_tp1_short_mostrado := false
            reentrada_tp3_ema13_tp2_short_mostrado := false
            esperando_reentrada_tp3_ema13_short := false
            label.new(bar_index, high + syminfo.mintick * 25, "REENTRADA TP3 EMA13 SHORT\n" + str.tostring(reentrada_tp3_ema13_precio_entrada_short, "#.#####"), style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white)
            alert('{"evento":"REENTRADA TP3 EMA13 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_precio_entrada_short) + ',"stop_loss":' + safeToString(reentrada_tp3_ema13_sl_short) + ',"tp1":' + safeToString(reentrada_tp3_ema13_tp1_short) + ',"tp2":' + safeToString(reentrada_tp3_ema13_tp2_short) + ',"tp3":' + safeToString(reentrada_tp3_ema13_tp3_short) + ',"tp1_pct":0.33,"tp2_pct":0.33,"tp3_pct":0.34}', alert.freq_once_per_bar)
            alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_short) + '}', alert.freq_once_per_bar)

// Gesti√≥n de la reentrada LONG
if reentrada_tp3_ema13_activa_long
    // SL din√°mico en EMA34
    reentrada_tp3_ema13_sl_long := ema34
    // SL tocado
    if low <= reentrada_tp3_ema13_sl_long
        label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 ‚Üì\n" + safeToString(reentrada_tp3_ema13_sl_long) + "\n(REENTRADA TP3 EMA13 LONG)", style=label.style_label_up, color=color.yellow, textcolor=color.black)
        alert('{"evento":"SL REENTRADA TP3 EMA13 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(low) + ',"stop_loss":' + safeToString(reentrada_tp3_ema13_sl_long) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_activa_long := false
    // TP1
    if not reentrada_tp3_ema13_tp1_long_mostrado and high >= reentrada_tp3_ema13_tp1_long
        label.new(bar_index, reentrada_tp3_ema13_tp1_long + syminfo.mintick * 10, "TP1 REENTRADA\n" + safeToString(reentrada_tp3_ema13_tp1_long), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP1 REENTRADA TP3 EMA13 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp1_long) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_sl_long := reentrada_tp3_ema13_precio_entrada_long
        reentrada_tp3_ema13_tp1_long_mostrado := true
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_long) + '}', alert.freq_once_per_bar)
    // TP2
    if reentrada_tp3_ema13_tp1_long_mostrado and not reentrada_tp3_ema13_tp2_long_mostrado and high >= reentrada_tp3_ema13_tp2_long
        label.new(bar_index, reentrada_tp3_ema13_tp2_long + syminfo.mintick * 10, "TP2 REENTRADA\n" + safeToString(reentrada_tp3_ema13_tp2_long), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP2 REENTRADA TP3 EMA13 LONG","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp2_long) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_sl_long := reentrada_tp3_ema13_tp1_long
        reentrada_tp3_ema13_tp2_long_mostrado := true
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_long) + '}', alert.freq_once_per_bar)
    // TP3 (cierre)
    if high >= reentrada_tp3_ema13_tp3_long
        label.new(bar_index, reentrada_tp3_ema13_tp3_long + syminfo.mintick * 10, "TP3 REENTRADA (CIERRE)\n" + safeToString(reentrada_tp3_ema13_tp3_long), style=label.style_label_down, color=color.green, textcolor=color.white)
        alert('{"evento":"TP3 REENTRADA TP3 EMA13 LONG - CIERRE","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp3_long) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_activa_long := false
        reentrada_tp3_ema13_tp1_long_mostrado := false
        reentrada_tp3_ema13_tp2_long_mostrado := false

// Gesti√≥n de la reentrada SHORT
if reentrada_tp3_ema13_activa_short
    // SL din√°mico en EMA34
    reentrada_tp3_ema13_sl_short := ema34
    // SL tocado
    if high >= reentrada_tp3_ema13_sl_short
        label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 ‚Üë\n" + safeToString(reentrada_tp3_ema13_sl_short) + "\n(REENTRADA TP3 EMA13 SHORT)", style=label.style_label_down, color=color.yellow, textcolor=color.black)
        alert('{"evento":"SL REENTRADA TP3 EMA13 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(high) + ',"stop_loss":' + safeToString(reentrada_tp3_ema13_sl_short) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_activa_short := false
    // TP1
    if not reentrada_tp3_ema13_tp1_short_mostrado and low <= reentrada_tp3_ema13_tp1_short
        label.new(bar_index, reentrada_tp3_ema13_tp1_short - syminfo.mintick * 10, "TP1 REENTRADA\n" + safeToString(reentrada_tp3_ema13_tp1_short), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP1 REENTRADA TP3 EMA13 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp1_short) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_sl_short := reentrada_tp3_ema13_precio_entrada_short
        reentrada_tp3_ema13_tp1_short_mostrado := true
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_short) + '}', alert.freq_once_per_bar)
    // TP2
    if reentrada_tp3_ema13_tp1_short_mostrado and not reentrada_tp3_ema13_tp2_short_mostrado and low <= reentrada_tp3_ema13_tp2_short
        label.new(bar_index, reentrada_tp3_ema13_tp2_short - syminfo.mintick * 10, "TP2 REENTRADA\n" + safeToString(reentrada_tp3_ema13_tp2_short), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP2 REENTRADA TP3 EMA13 SHORT","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp2_short) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_sl_short := reentrada_tp3_ema13_tp1_short
        reentrada_tp3_ema13_tp2_short_mostrado := true
        alert('{"evento":"ACTUALIZA SL DINAMICO","symbol":"' + safeToString(syminfo.ticker) + '","stop_loss":' + safeToString(reentrada_tp3_ema13_sl_short) + '}', alert.freq_once_per_bar)
    // TP3 (cierre)
    if low <= reentrada_tp3_ema13_tp3_short
        label.new(bar_index, reentrada_tp3_ema13_tp3_short - syminfo.mintick * 10, "TP3 REENTRADA (CIERRE)\n" + safeToString(reentrada_tp3_ema13_tp3_short), style=label.style_label_up, color=color.red, textcolor=color.white)
        alert('{"evento":"TP3 REENTRADA TP3 EMA13 SHORT - CIERRE","symbol":"' + safeToString(syminfo.ticker) + '","precio":' + safeToString(reentrada_tp3_ema13_tp3_short) + '}', alert.freq_once_per_bar)
        reentrada_tp3_ema13_activa_short := false
        reentrada_tp3_ema13_tp1_short_mostrado := false
        reentrada_tp3_ema13_tp2_short_mostrado := false
        
alertcondition(cruceAlcistaValidado, title="Alerta LONG", message="LONG - Entrada: {{open}} o {{close}} - TP1: {{open * 1.01}} - TP2: {{open * 1.03}} - TP3: {{open * 1.05}}")
alertcondition(cruceBajistaValidado, title="Alerta SHORT", message="SHORT - Entrada: {{close}} o {{open}} - TP1: {{close * 0.99}} - TP2: {{close * 0.97}} - TP3: {{close * 0.95}}")